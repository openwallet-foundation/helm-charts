{{- if .Values.postgres.enabled -}}
{{ $databaseSecretName := (include "endorser-service.db.secretName" .) }}
{{ $adminPassword := include "getOrGeneratePass" (dict "Namespace" .Release.Namespace "Kind" "Secret" "Name" $databaseSecretName "Key" "postgres-password" "Length" 32) }}
{{ $userPassword := include "getOrGeneratePass" (dict "Namespace" .Release.Namespace "Kind" "Secret" "Name" $databaseSecretName "Key" "password" "Length" 32) }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $databaseSecretName }}
  namespace: {{ .Release.Namespace | quote }}
  {{- if .Values.secrets.database.retainOnUninstall }}
  annotations:
    "helm.sh/resource-policy": keep
  {{- end }}
  labels:
    {{- include "endorser-service.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: Opaque
data:
  database: {{ (.Values.postgres.customUser.database | default .Values.postgres.customUser.name) | b64enc | quote }}
  password: {{ $userPassword }}
  postgres-password: {{ $adminPassword }}
  user: {{ .Values.postgres.customUser.name | b64enc | quote }}
{{- end }}
