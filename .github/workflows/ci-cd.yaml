name: Helm Chart CI/CD

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main
    paths:
      - 'charts/**'
  push:
    branches:
      - main
    paths:
      - 'charts/**'

jobs:
  detect-changed-chart:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed chart
        id: detect
        uses: ./.github/actions/detect-chart
    outputs:
      chart: ${{ steps.detect.outputs.chart }}

  lint-test:
    runs-on: ubuntu-latest
    needs: detect-changed-chart
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/yq
            ~/.cache/helm
            ~/.npm
          key: ${{ runner.os }}-deps-${{ needs.detect-changed-chart.outputs.chart }}-${{ hashFiles('${{ needs.detect-changed-chart.outputs.chart }}/**/*') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.0
        with:
          version: v3.18.4

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.7.0

      - name: Add Helm repos from chart dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          npm install -g yq
          charts=$(cat changed.txt 2>/dev/null || find charts -mindepth 1 -maxdepth 1 -type d)
          repos=""
          for chart in $charts; do
            if [ -f "$chart/Chart.yaml" ]; then
              yq '.dependencies // [] | .[] | .repository' "$chart/Chart.yaml"
            fi
          done | sort | uniq | while read repo; do
            if [ -n "$repo" ]; then
              name=$(echo "$repo" | sed 's|https\?://||;s|/|_|g')
              helm repo add "$name" "$repo" || true
            fi
          done

      - name: Update Helm dependencies
        run: |
          for chart in $(cat changed.txt); do
            if [ -f "$chart/Chart.yaml" ]; then
              helm dependency update "$chart" || {
                echo "âŒ Failed to update dependencies for $chart"
                exit 1
              }
            fi
          done

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.7.0

      - name: Find changed or new charts
        id: changed
        run: |
          changed=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '^charts/' | cut -d'/' -f2 | uniq)
          if [ -z "$changed" ]; then
            changed=$(git ls-files --others --exclude-standard charts/ | cut -d'/' -f2 | uniq)
          fi
          if [ -n "$changed" ]; then
            echo "$changed" > changed.txt
            echo "charts=$changed" >> $GITHUB_OUTPUT
          else
            echo "No charts changed or added" > changed.txt
            echo "charts=" >> $GITHUB_OUTPUT
          fi

      - name: Lint changed chart
        run: ct lint --charts "$(cat changed.txt)" --config .github/ct.yaml

      - name: Create kind cluster
        uses: helm/kind-action@v1

      - name: Test install changed chart
        run: ct install --charts "$(cat changed.txt)" --config .github/ct.yaml

      - name: Check version and appVersion bump
        if: steps.changed.outputs.charts != ''
        run: |
          for chart in $(cat changed.txt); do
            echo "Checking $chart..."

            old_version=$(git show ${{ github.event.pull_request.base.sha }}:$chart/Chart.yaml 2>/dev/null | yq '.version' || echo "0.0.0")
            new_version=$(yq '.version' $chart/Chart.yaml)

            old_app=$(git show ${{ github.event.pull_request.base.sha }}:$chart/Chart.yaml 2>/dev/null | yq '.appVersion' || echo "0.0.0")
            new_app=$(yq '.appVersion' $chart/Chart.yaml)

            if [[ "$old_version" == "$new_version" ]]; then
              echo "âŒ Chart version was not bumped in $chart (still $new_version)"
              exit 1
            fi

            if [[ "$old_app" == "$new_app" ]]; then
              echo "âš ï¸ Warning: appVersion for $chart is unchanged ($new_app). Not failing, but consider bumping."
            fi
          done

      - name: Set up Node.js for generators
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install readme and changelog generators
        if: steps.changed.outputs.charts != ''
        run: |
          npm install -g @bitnami/readme-generator-for-helm conventional-changelog-cli conventional-changelog-conventionalcommits

      - name: Generate and check README and CHANGELOG
        if: steps.changed.outputs.charts != ''
        run: |
          need_update=""
          chart=$(cat changed.txt)
          # Generate README
          npx @bitnami/readme-generator-for-helm --readme $chart/README.md --values $chart/values.yaml
          # Check whether README.md was updated in the PR
          if ! git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -q "^$chart/README.md$"; then
            echo "âŒ README.md for $chart was not updated in the PR. Please re-run the generator."
            need_update="yes"
          # Confirm README.md has been generated and committed correctly
          elif ! git diff --exit-code -- $chart/README.md > /dev/null; then
            echo "âŒ README.md for $chart has uncommitted changes. Please commit the updated file."
            need_update="yes"
          else
            echo "âœ… README.md for $chart is up to date and committed."
          fi

          # Check that CHANGELOG.md was updated
          if [ -n "$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} $chart/ | grep -E 'Chart.yaml|values.yaml|templates/')" ]; then
            if ! git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -q "^$chart/CHANGELOG.md$"; then
              echo "âŒ CHANGELOG.md not updated for $chart. Please run conventional-changelog-cli."
              need_update="yes"
            fi
          fi
          if [ "$need_update" = "yes" ]; then
            exit 1
          fi
      - name: Post PR comment on failure
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âŒ PR checks failed. Review logs for linting, testing, or validation errors.'
            })

  publish:
    runs-on: ubuntu-latest
    needs: lint-test
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.0
        with:
          version: v3.18.4

      - name: Add Helm repos from chart dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          npm install -g yq
          charts=$(cat changed.txt 2>/dev/null || find charts -mindepth 1 -maxdepth 1 -type d)
          repos=""
          for chart in $charts; do
            if [ -f "$chart/Chart.yaml" ]; then
              yq '.dependencies // [] | .[] | .repository' "$chart/Chart.yaml"
            fi
          done | sort | uniq | while read repo; do
            if [ -n "$repo" ]; then
              name=$(echo "$repo" | sed 's|https\?://||;s|/|_|g')
              helm repo add "$name" "$repo" || true
            fi
          done

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.7.0

      - name: Detect and package changed charts
        id: detect
        run: |
          mkdir -p .cr-release-packages
          mkdir -p .cr-existing-index

          # Clone existing gh-pages to get current index.yaml
          git fetch origin gh-pages
          git show origin/gh-pages:index.yaml > .cr-existing-index/index.yaml || echo "apiVersion: v1\nentries: {}\ngenerated: $(date -u +%Y-%m-%dT%H:%M:%SZ)" > .cr-existing-index/index.yaml

          # Find all charts in /charts
          charts=$(find charts -mindepth 1 -maxdepth 1 -type d)

          # Determine which ones need packaging
          to_package=""
          for chart in $charts; do
            name=$(yq '.name' $chart/Chart.yaml)
            version=$(yq '.version' $chart/Chart.yaml)

            # Check if the chart exists in index.yaml
            if yq eval "(.entries.\"$name\" | type) == \"array\"" .cr-existing-index/index.yaml > /dev/null 2>&1; then
              existing_versions=$(yq eval ".entries[\"$name\"][].version" .cr-existing-index/index.yaml)
              if ! echo "$existing_versions" | grep -q "^$version$"; then
                echo "ðŸ“¦ New version detected for chart $name: $version"
                helm package "$chart" --destination .cr-release-packages
                to_package+="$chart,"
              else
                echo "âœ”ï¸ Chart $name version $version already exists in index"
              fi
            else
              echo "ðŸ“¦ New chart detected: $name-$version"
              helm package "$chart" --destination .cr-release-packages
              to_package+="$chart,"
            fi
          done

          to_package=${to_package%,} # Trim trailing comma
          echo "charts=$to_package" >> $GITHUB_OUTPUT

      - name: Update index.yaml
        if: steps.detect.outputs.charts != ''
        run: |
          helm repo index .cr-release-packages --url https://openwallet-foundation.github.io/helm-charts/

      - name: Deploy to GitHub Pages
        if: steps.detect.outputs.charts != ''
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .cr-release-packages
          publish_branch: gh-pages
